# Архитектура Video Downloader

## Обзор

Video Downloader был рефакторирован для улучшения читаемости, тестируемости и поддерживаемости кода. Новая архитектура разделяет функциональность на логические модули с четким разделением ответственности.

## Структура модулей

### `src/config.py`
- **Назначение**: Управление конфигурацией приложения
- **Классы**: `Config`
- **Функции**: Загрузка из TOML, валидация параметров

### `src/browser.py`
- **Назначение**: Управление браузерными профилями и куки
- **Классы**: `BrowserProfileManager`
- **Функции**: Поиск профилей, сопоставление имен, извлечение куки

### `src/downloader.py`
- **Назначение**: Основная логика скачивания видео
- **Классы**: `VideoDownloader`
- **Функции**: Скачивание через yt-dlp, fallback на браузер

### `src/file_manager.py`
- **Назначение**: Управление файлами и очистка артефактов
- **Классы**: `FileManager`
- **Функции**: Очистка частичных файлов, проверка существования

### `src/playwright_capture.py`
- **Назначение**: Захват видео через браузер
- **Классы**: `PlaywrightCapture`
- **Функции**: Захват манифестов, браузерное скачивание, обнаружение DRM

### `src/utils.py`
- **Назначение**: Вспомогательные функции
- **Функции**: Чтение файлов ссылок, валидация URL, настройка логирования

### `src/cli.py`
- **Назначение**: CLI интерфейс
- **Функции**: Парсинг аргументов, главная функция CLI

## Жизненный цикл скачивания

1. **Config** - Загрузка и валидация конфигурации
2. **Browser Setup** - Настройка браузерного профиля и куки
3. **Download** - Попытка скачивания через yt-dlp
4. **Fallback** - При неудаче - браузерное скачивание
5. **Cleanup** - Очистка артефактов и создание отчетов

## Обработка ошибок

- Структурированное логирование с фазами START/DONE/FAIL
- Graceful fallback между методами скачивания
- Автоматическая очистка частичных файлов
- Детальная статистика по доменам

## Точка входа

Единый файл `main.py` служит главной точкой входа:
- Простой импорт модулей из `src/`
- Вызов CLI интерфейса
- Чистая структура без legacy кода

## Тестирование

Тесты расположены в `tests/` и покрывают:
- Конфигурацию (`test_config.py`)
- Управление файлами (`test_file_manager.py`)
- Утилиты (`test_utils.py`)

Запуск тестов:
```bash
pytest
```

## Логирование

Новая система логирования использует структурированные логи с:
- Фазами операций (START/DONE/FAIL)
- Дополнительными метаданными через `extra`
- Четким разделением уровней логирования

## Безопасность

- Валидация всех входных параметров
- Безопасная работа с файлами и путями
- Изоляция браузерных профилей
- Обработка секретов (куки) без логирования
